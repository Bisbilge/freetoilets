<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreeToilet.org | √úcretsiz Tuvalet Bul</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; }
        #map { height: 100vh; width: 100%; }
        
        /* Popup Tasarƒ±mƒ± */
        .info-box { padding: 10px; min-width: 200px; }
        .popup-title { margin: 0 0 10px 0; color: #2c3e50; font-size: 16px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .price-tag { color: #e74c3c; font-weight: bold; }
        .free-tag { color: #27ae60; font-weight: bold; }
        .code-box { background: #f1f2f6; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-weight: bold; }
        .report-link { display: block; margin-top: 10px; color: #e74c3c; text-decoration: none; font-size: 12px; font-weight: bold; text-align: center; border: 1px solid #ffdcdc; padding: 5px; border-radius: 5px; }
        .report-link:hover { background: #fff0f0; }

        #report-btn {
            position: fixed;
            bottom: 30px;
            right: 20px;
            z-index: 1000;
            background-color: #2ecc71;
            color: white;
            padding: 14px 22px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: bold;
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
            transition: transform 0.2s, background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #report-btn:hover { background-color: #27ae60; transform: translateY(-3px); }

        @media (max-width: 600px) {
            #report-btn { bottom: 20px; right: 10px; padding: 10px 18px; font-size: 14px; }
        }
    </style>
</head>
<body>

<div id="map"></div>

<a id="report-btn" href="/report/">
    <span>üìç</span> Tuvalet Bildir
</a>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
    // --- G√úVENLƒ∞K ZIRHI: XSS ENGELLEME FONKSƒ∞YONU ---
    function escapeHTML(str) {
        if (!str) return "";
        return String(str).replace(/[&<>"']/g, function(m) {
            return {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[m];
        });
    }

    var map = L.map('map').setView([41.0082, 28.9784], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    var markers = L.markerClusterGroup({
        maxClusterRadius: 30,
        disableClusteringAtZoom: 17,
        spiderfyOnMaxZoom: true
    });

    

    fetch('/api/toilets/')
        .then(response => response.json())
        .then(data => {
            data.forEach(toilet => {
                // VERƒ∞LERƒ∞ S√úZGE√áTEN GE√áƒ∞Rƒ∞YORUZ
                const safeName = escapeHTML(toilet.name);
                const safeCode = escapeHTML(toilet.code || 'Yok / Gerekmiyor');
                const safeDesc = escapeHTML(toilet.desc || '');
                const safePrice = escapeHTML(toilet.price || '0');

                var status = toilet.is_free ? 
                    '<span class="free-tag">√úcretsiz</span>' : 
                    `<span class="price-tag">√úcret: ${safePrice} TL</span>`;

                var popupContent = `
                    <div class="info-box">
                        <h3 class="popup-title">${safeName}</h3>
                        <p style="margin:5px 0;">${status}</p>
                        <p style="margin:5px 0;"><b>≈ûifre:</b> <span class="code-box">${safeCode}</span></p>
                        <p style="margin:5px 0; font-size: 0.9em; color: #555; font-style: italic;">"${safeDesc}"</p>
                        <a href="/report-issue/?id=${toilet.id}" class="report-link">‚ö†Ô∏è Hata Bildir / G√ºncelle</a>
                    </div>
                `;

                var marker = L.marker([toilet.lat, toilet.lng]).bindPopup(popupContent);
                markers.addLayer(marker);
            });
            map.addLayer(markers);
        })
        .catch(err => console.error("Veri y√ºklenemedi:", err));

    // Konum Bulma
    map.locate({setView: true, maxZoom: 16});
    map.on('locationfound', function(e) {
        var radius = e.accuracy / 2;
        L.circle(e.latlng, radius, {color: '#3498db', fillColor: '#3498db', fillOpacity: 0.2}).addTo(map).bindPopup("≈ûu an buradasƒ±nƒ±z").openPopup();
    });
</script>

</body>
</html>