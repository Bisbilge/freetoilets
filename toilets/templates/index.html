<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreeToilet.org | √úcretsiz Tuvalet Bul</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #map { height: 100vh; width: 100%; }
        .info-box { padding: 10px; min-width: 150px; }
        .price-tag { color: #e74c3c; font-weight: bold; }
        .free-tag { color: #27ae60; font-weight: bold; }
        
        #report-btn {
            position: fixed;
            bottom: 30px;
            right: 20px;
            z-index: 1000;
            background-color: #2ecc71;
            color: white;
            padding: 14px 22px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: transform 0.2s, background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #report-btn:hover {
            background-color: #27ae60;
            transform: scale(1.05);
        }

        @media (max-width: 600px) {
            #report-btn {
                bottom: 20px;
                right: 10px;
                padding: 10px 18px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>

<div id="map"></div>

<a id="report-btn" href="/report/">
    <span>üìç</span> Tuvalet Bildir
</a>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
    var map = L.map('map').setView([41.0082, 28.9784], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // K√úMELEME AYARLARI G√úNCELLENDƒ∞
    var markers = L.markerClusterGroup({
        maxClusterRadius: 30, // Baloncuklarƒ±n birbirini yutma mesafesini azalttƒ±k (Varsayƒ±lan 80'di)
        disableClusteringAtZoom: 17, // 17 zoom seviyesine gelince k√ºmelemeyi tamamen iptal et, tekil g√∂ster
        spiderfyOnMaxZoom: true // Aynƒ± noktadaki markerlarƒ± bacak gibi a√ßar
    });

    fetch('/api/toilets/')
        .then(response => response.json())
        .then(data => {
            data.forEach(toilet => {
                var status = toilet.is_free ? 
                    '<span class="free-tag">√úcretsiz</span>' : 
                    `<span class="price-tag">√úcret: ${toilet.price} TL</span>`;

                var popupContent = `
                    <div class="info-box">
                        <h3 style="margin:0 0 10px 0;">${toilet.name}</h3>
                        <p style="margin:5px 0;">${status}</p>
                        <p style="margin:5px 0;"><b>≈ûifre:</b> <code>${toilet.code || 'Yok'}</code></p>
                        <p style="margin:5px 0; font-size: 0.9em; color: #555;">${toilet.desc || ''}</p>
                    </div>
                `;

                var marker = L.marker([toilet.lat, toilet.lng])
                    .bindPopup(popupContent);
                
                markers.addLayer(marker);
            });
            
            map.addLayer(markers);
        })
        .catch(err => console.error("Veri y√ºklenemedi:", err));

    map.locate({setView: true, maxZoom: 16});

    function onLocationFound(e) {
        var radius = e.accuracy / 2;
        L.circle(e.latlng, radius).addTo(map).bindPopup("≈ûu an buradasƒ±nƒ±z").openPopup();
    }
    map.on('locationfound', onLocationFound);
</script>

</body>
</html>